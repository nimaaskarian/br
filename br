#!/usr/bin/env bash
BR_ENCRYPTED=${BR_ENCRYPTED:-0}
BR_VAULT=${BR_VAULT:-"$HOME/Documents/br-vault"}
BR_DATE=${BR_DATE:-"date +%F"}
BR_ENCRYPT=${BR_ENCRYPT_CMD:-"gpg --symmetric --output %o %i"}
BR_DECRYPT=${BR_DECRYPT_CMD:-"gpg -d %o > %i"}
BR_REMOVER=${BR_REMOVER:-"rm"}

fatal() {
  1>&2 echo Error: "$@"
  exit 1
}

source_config() {
  config_file="$1"
  if [ -f "$config_file" ]; then
    . "$config_file"
  fi
}

make_gpg_cmd() {
  echo "$1" | sed "s+%i+\"$2\"+" | sed "s+%o+\"$3\"+"
}

rgfzf() {
  cd "$1" || return 1
  rg --color=always --line-number --no-heading --smart-case -v '^\s*$' \
  | fzf -d':' --ansi \
    --preview "bat -p --color=always {1} --highlight-line {2}" \
    --preview-window ~8,+{2}-5 \
  | awk -F':' '{print $1}'
}

edit_rgfzf() {
  vault=$1
  name=$(rgfzf "$vault")
  ! [ "$name" ] && exit 1
  resolve_name "$vault" "$name"
}

edit_encrypted() {
  name=$(printf "%s" "$1" | sed 's+.gpg$++')
  SUFFIX=".${name##*.}"
  TMP=$(mktemp --suffix "$SUFFIX")
  
  if [ -f "$name.gpg" ]; then
    eval "$(make_gpg_cmd "$BR_DECRYPT" "$TMP" "$name.gpg")"
  fi
  before=$(cat "$TMP")
  $EDITOR_ "$TMP"
  after=$(cat "$TMP")
  if ! [ "$before" = "$after" ]; then
    eval "$(make_gpg_cmd "$BR_ENCRYPT" "$TMP" "$name.gpg")"
  fi
  $BR_REMOVER "$TMP"
}

make_journal_path() {
  if [ "$BR_NAME" ] && [ -d "$BR_VAULT/${BR_NAME}" ]; then
    name=$BR_NAME/$($BR_DATE)
  elif [ "$BR_NAME" ]; then
    name=$BR_NAME

  else
    name=$($BR_DATE)
  fi

  dir="${BR_VAULT}/$(dirname "$name")"
  if ! [ -d "$dir" ]; then
    mkdir -p "$dir"
  fi
  echo "${BR_VAULT}/$name.md"
}

set_encrypted_editor() {
  EDITOR_=$EDITOR
  EDITOR=edit_encrypted
}

search_vault() {
  name=$(fd -tf -H --base-directory "$1" $2 | fzf --tac) || exit 1
  resolve_name "$1" "$name"
}

resolve_name()  {
  name=$2
  if echo "$name" | grep '.gpg$'; then
    BR_ENCRYPTED=1
  fi
  FILE_PATH="$1/$name"
}

zip_vault() {
  zip -r "$1" "$BR_VAULT"
}

convert_file_to_doc() {
  in=$2
  out=$1
  pandoc $PANDOC_OPTS "$in" -o "$out"
}

usage() {
  cat << EOF
Usage:
  br [OPTIONS] [NAME]

Arguments:
   [VAULT_PATH] Path to vault directory

Commands:
$(br lscmd)

Options:
  -n <NAME>
    Edit named journal
  -v <BR_VAULT> 
    use <BR_VAULT> as vault
  -l
    Use PAGER (less) instead of EDITOR
  -e
    Edit journal/note as encrypted
  -d
    Print the path of current vault
  -D
    Print the path of selected file
  -c
    Load another config file (arguments will replace cli and config options up to that point)
  -p
    Use "echo" as EDITOR (print the name of the file)
  -t
    Search journals and notes by text inside them
  -a
    Echo path to all journals
EOF
}

while getopts ":hn:lec:v:p" option; do
  case $option in 
    h) 
      usage
      exit;;
    v)
      BR_VAULT=${OPTARG};;
    n) 
      BR_NAME=${OPTARG}
      ;;
    c) 
      source_config "${OPTARG}";;
    p)
      EDITOR="echo";;
    l) 
      EDITOR=${PAGER:-less};;
    e) 
      BR_ENCRYPTED=1;;
    \?) 
      fatal invalid option
  esac
done
shift $((OPTIND - 1))
mkdir -p "$BR_VAULT" 2> /dev/null
if [ -n "$1" ]; then
  case $1 in 
    grep) 
      edit_rgfzf "$BR_VAULT";;
    search)
      search_vault "$BR_VAULT";;
    ls)
      fd -tf -e md . "$BR_VAULT" --color never
      exit 0
      ;;
    pandoc) 
      [ -z "$2" ] && {
        fatal pandoc requires an argument
      }
      EDITOR="convert_file_to_doc $2"
      exit
      ;;
    parad)
      mkdir "$BR_VAULT"/{projects,areas,resources,archives,diary}
      exit
      ;;
    zip)
      [ -z "$2" ] && {
        fatal zip requires an argument
      }
      zip_vault "$2"
      exit
      ;;
    lscmd)
      cat << EOF
grep
search
ls
pandoc
zip
parad
lscmd
EOF
exit
;;
  esac
fi
FILE_PATH=${FILE_PATH:-$(make_journal_path)}
if [ "$BR_ENCRYPTED" = 1 ]; then
  set_encrypted_editor
fi

$EDITOR "$FILE_PATH"
