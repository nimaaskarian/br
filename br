#!/bin/sh
CONFIG_DIR=${XDG_CONFIG_HOME:-${HOME}/.config}/br

source_config() {
  if [ -f "$CONFIG_DIR/brrc" ]; then
    . $CONFIG_DIR/brrc
  fi

  if [ "${ENCRYPTED}" = 1 ]; then
    EDITOR_=$EDITOR
    EDITOR=edit_encrypted
  fi
}

edit_encrypted() {
  TMP=$(mktemp --suffix "$SUFFIX")
  if [ -f "$1.gpg" ]; then
    gpg -d "$1.gpg" > "$TMP"
  fi
  $EDITOR_ "$TMP"
  gpg --symmetric --output "$1.gpg" "$TMP"
  rm "$TMP"
}

make_journal_path() {
  NAME=${1:-$($DATE)}
  echo "${VAULT}/${PREFIX}${NAME}${SUFFIX}"
}

make_vault() {
  VAULT=${1:-$VAULT}
  if [ "$notemode" = 1 ]; then
    VAULT=$VAULT/notes
  fi
  mkdir "$VAULT" 2> /dev/null
}

print() {
  printf "$*\n"
}

print_help() {
  print "Usage:"
  print "\tbr [OPTIONS] [VAULT_PATH]"
  print "Arguments:"
  print "\t [VAULT_PATH] Path to vault directory"
  print "Options:"
}

source_config "$@"
while getopts "hn:" option; do
  case $option in 
    h) 
      print_help
      exit;;
    n) 
      notemode=1
      name=${OPTARG};;
    \?) 
      echo "Error: Invalid option"
      exit 1;;
  esac
done
shift $((OPTIND - 1))
make_vault "$@"
FILE_PATH=$(make_journal_path "$name")

$EDITOR "$FILE_PATH"
